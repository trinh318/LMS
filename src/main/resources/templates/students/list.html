<div class="px-5" th:fragment="content" xmlns:th="http://www.w3.org/1999/xhtml">
    <div class="container-fluid py-2">
        <!-- Header -->
        <div class="col-12 text-center mb-4">
            <h1 class="fw-bold">Students</h1>
        </div>

        <!-- Alerts Section -->
        <div th:fragment="alerts" class="mb-4">
            <div id="alertContainer">
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-lg me-2"></i>
                        <span th:text="${success}"></span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle fa-lg me-2"></i>
                        <span th:text="${error}"></span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Search and Actions Bar -->
        <div class="card-body mb-3">
            <div class="row align-items-center gy-3">
                <!-- Search Form -->
                <div class="col-md-6 d-flex">
                    <form class="input-group me-2">
                        <input type="text" class="form-control" name="searchTerm" id="searchInput"
                            placeholder="Search by student name" aria-label="Student search">
                        <button type="submit" class="btn btn-sm btn-outline-secondary" aria-label="Search"
                            title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="window.location.href='/students'" title="Reload" aria-label="Reload students">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="col-md-6 d-flex justify-content-end gap-2 flex-wrap">
                    <!-- Import Button -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-upload"></i>
                        </button>
                        <ul class="dropdown-menu" style="cursor: pointer;">
                            <li>
                                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#importModal">
                                    <i class="fas fa-user me-2"></i> Import Student
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#importCardModal">
                                    <i class="fas fa-id-badge me-2"></i> Import Card
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Export Button Group -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdownBtn"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-excel"></i>
                        </button>

                        <div class="dropdown-menu p-3" style="width: 250px;">
                            <!-- Select Export Type -->
                            <div class="mb-2">
                                <label class="form-label fw-bold small">Select Export Type:</label>
                                <select id="exportType" class="form-select form-select-sm">
                                    <option value="student">Student</option>
                                    <option value="studentCard">Student Card</option>
                                </select>
                            </div>

                            <!-- Select Target -->
                            <div class="mb-2">
                                <label class="form-label fw-bold small">Select Target:</label>
                                <select id="exportTarget" class="form-select form-select-sm">
                                    <option value="all">All</option>
                                    <option value="selected">Selected</option>
                                </select>
                            </div>

                            <!-- Select Format -->
                            <div class="mb-2">
                                <label class="form-label fw-bold small">Select Format:</label>
                                <select id="exportFormat" class="form-select form-select-sm">
                                    <option value="excel">Excel (.xlsx)</option>
                                    <option value="csv">CSV (.csv)</option>
                                    <option value="pdf">PDF (.pdf)</option>
                                </select>
                            </div>

                            <!-- Export Now button -->
                            <div class="d-grid mt-3">
                                <button class="btn btn-primary btn-sm" onclick="handleExport()">Export Now</button>
                            </div>
                        </div>
                    </div>

                    <!-- Print Button -->
                    <a href="/students/print" class="btn btn-outline-secondary" title="Print" id="printTable">
                        <i class="bi bi-printer"></i>
                    </a>

                    <!-- Create Button -->
                    <a href="/students/new" class="btn btn-primary" title="Create New student">
                        <i class="bi bi-plus-circle"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importModalLabel">Import students from Excel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Download the Excel template before uploading your file:</p>
                        <a id="downloadTemplateBtn" class="text-primary text-decoration-underline"
                            style="cursor: pointer;">
                            Download Student Template
                        </a>
                        <form id="importForm" enctype="multipart/form-data" class="mt-3">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Choose Excel File</label>
                                <input type="file" name="file" id="fileInput" class="form-control" accept=".xlsx,.xls"
                                    required>
                            </div>
                            <div id="previewTableContainer" class="table-responsive d-none">
                                <label class="form-label">Preview Data:</label>
                                <div id="previewTableWrapper" style="max-height: 300px; overflow: auto;">
                                    <table class="table table-bordered table-sm table-fixed-header"
                                        style="min-width: 800px;">
                                        <thead class="table-light position-sticky top-0" style="z-index: 1;">
                                            <tr id="previewHeaderRow"></tr>
                                        </thead>
                                        <tbody id="previewBodyRows"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-upload"></i> Import
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import 1 Card Modal -->
        <div class="modal fade" id="importCardModal" tabindex="-1" aria-labelledby="importCardModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importCardModalLabel">Import Card from Excel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>You can download the card template before uploading:</p>
                        <a id="downloadCardTemplateBtn" class="text-primary text-decoration-underline"
                            style="cursor: pointer;">
                            Download Card Template
                        </a>
                        <form id="importCardForm" enctype="multipart/form-data" class="mt-3">
                            <div class="mb-3">
                                <label for="cardFileInput" class="form-label">Choose Card Excel File</label>
                                <input type="file" name="file" id="cardFileInput" class="form-control"
                                    accept=".xlsx,.xls" required>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-upload"></i> Import
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duplicate Students Modal -->
        <div class="modal fade" id="duplicateModal" tabindex="-1" aria-labelledby="duplicateModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Duplicate Students</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <p><span id="duplicateCount"></span> student(s) already exist in the system.</p>

                        <!-- Scroll container -->
                        <div id="duplicateTableContainer" class="table-responsive"
                            style="max-height: 400px; overflow: auto;">
                            <table class="table table-bordered table-sm" style="min-width: 800px;">
                                <thead class="table-light position-sticky top-0" style="z-index: 1;">
                                    <tr id="duplicateHeaderRow"></tr>
                                </thead>
                                <tbody id="duplicateBodyRows" style="border-color: rgba(0,0,0,0.2);"></tbody>
                            </table>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button id="reImportBtn" type="button" class="btn btn-primary">Re-Import</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="loadingOverlay"
            class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75"
            style="z-index: 2000; display: none !important;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Importing...</span>
            </div>
        </div>

        <!-- Main Content -->
        <main>
            <div id="studentTableCard" class="card border-0 shadow-sm">
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="bg-light position-sticky top-0" style="z-index: 1;">
                            <tr>
                                <th class="no-print"><input type="checkbox" id="selectAll"></th>
                                <th scope="col" class="fw-semibold text-center" data-column="index">#</th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable"
                                    data-sort="studentCode">
                                    <div class="sort-wrapper">
                                        Student Code
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable"
                                    data-sort="studentCode">
                                    <div class="sort-wrapper">
                                        Card Number
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable"
                                    data-sort="lastName">
                                    <div class="sort-wrapper">
                                        Last Name
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable"
                                    data-sort="firstName">
                                    <div class="sort-wrapper">
                                        First Name
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable" data-sort="email">
                                    <div class="sort-wrapper">
                                        Email
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center sort-header sortable"
                                    data-sort="phoneNumber">
                                    <div class="sort-wrapper">
                                        Phone Number
                                        <span class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-up"></i>
                                            <i class="bi bi-caret-down-fill sort-down"></i>
                                        </span>
                                    </div>
                                </th>

                                <th scope="col" class="fw-semibold text-center no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>

                <div class="table-footer d-flex align-items-center justify-content-between position-sticky bottom-0 bg-white py-2 px-3 border-top"
                    style="z-index: 2;">
                    <div class="d-flex align-items-center">
                        <button id="deleteAll" class="btn btn-danger me-3" data-bs-toggle="modal"
                            data-bs-target="#deleteAllModal">
                            <i class="bi bi-trash"></i>
                            <span>Delete Selected (<span id="selectedCount">0</span>)</span>
                        </button>
                        <span class="text-muted">Total Records:
                            <strong id="totalRecords">0</strong>
                        </span>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="student pagination">
                        <ul class="pagination justify-content-end mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Delete Modal -->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Confirm</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">Are you sure you want to delete this student?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Card Modal -->
            <div class="modal fade" id="deleteCardModal" tabindex="-1" aria-labelledby="deleteCardModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteCardModalLabel">Confirm</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">Are you sure you want to delete this student card?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button id="confirmDeleteCardBtn" type="button" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete All Modal -->
            <div class="modal fade" id="deleteAllModal" tabindex="-1" aria-labelledby="deleteAllModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteAllModalLabel">Confirm Deletion</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to delete <span id="deleteCount">0</span> selected student(s)?
                        </div>
                        <div class="modal-footer">
                            <form id="deleteAllForm">
                                <input type="hidden" name="ids" id="deleteAllIds">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyStateCard" class="card border-0 shadow-sm p-4 text-center d-none">
                <div class="py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5>No students Found</h5>
                    <p class="text-muted">There are no students available or matching your search criteria.</p>
                    <a class="btn btn-outline-primary mt-2">
                        <i class="fas fa-plus me-1"></i> Create student
                    </a>
                </div>
            </div>
        </main>
    </div>
    <link rel="stylesheet" th:href="@{/css/students/list.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        function renderStudentTable(students, currentPage = 0, pageSize = 10) {
            const tbody = $('#studentTableBody');
            const tableCard = $('#studentTableCard');
            const emptyCard = $('#emptyStateCard');
            tbody.empty();

            if (students.length === 0) {
                // Hiện empty state, ẩn bảng
                tableCard.addClass('d-none');
                emptyCard.removeClass('d-none');
                return;
            } else {
                // Có dữ liệu: hiện bảng, ẩn empty state
                tableCard.removeClass('d-none');
                emptyCard.addClass('d-none');
            }

            students.forEach((student, index) => {
                const rowNumber = index + 1 + (currentPage * pageSize);

                tbody.append(`
                    <tr>
                        <td><input type="checkbox" class="selectItem" value="${student.id}" /></td>
                        <td class="align-middle text-center">${rowNumber}</td>
                        <td class="align-middle text-center fw-bold">${student.studentCode || '-'}</td>
                        <td class="align-middle text-center fw-bold">
                            ${student.cardNumber
                        ? `<span>${student.cardNumber}</span>`
                        : `
                                    <div class="dropdown">
                                        <button 
                                            class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                            type="button"
                                            id="actionMenu_${student.id}" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            ${!student.studentCode ? 'disabled title="Student code is required"' : ''}
                                        >
                                            <i class="bi bi-plus-lg"></i> Cấp thẻ
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="actionMenu_${student.id}">
                                            <li>
                                                <a class="dropdown-item" href="/students/create-card/${student.id}">
                                                    <i class="bi bi-plus-circle me-2"></i> Add
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" onclick="openImportCardModal(${student.id})" style="cursor: pointer;">
                                                    <i class="bi bi-upload me-2"></i> Import
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                `
                    }
                        </td>
                        <td class="align-middle text-start">${student.lastName}</td>
                        <td class="align-middle text-start">${student.firstName}</td>
                        <td class="align-middle text-start">${student.email}</td>
                        <td class="align-middle text-center">${student.phoneNumber || '-'}</td>
                        <td class="text-center align-middle">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        id="studentActionMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="studentActionMenu">
                                    <!-- Student actions -->
                                    <li>
                                        <a class="dropdown-item" href="/students/detail/${student.id}">
                                            <i class="fas fa-eye me-2"></i> View Student
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="/students/edit/${student.id}">
                                            <i class="fas fa-edit me-2"></i> Edit Student
                                        </a>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" type="button" data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal" data-id="${student.id}">
                                            <i class="fas fa-trash me-2"></i> Delete Student
                                        </button>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="/students/edit-card/${student.id}">
                                            <i class="fas fa-id-card me-2"></i> Edit Card
                                        </a>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" type="button" data-bs-toggle="modal" 
                                                data-bs-target="#deleteCardModal" data-id="${student.id}">
                                            <i class="fas fa-trash me-2"></i> Delete Card
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                `);
            });

            // Gắn lại sự kiện cho nút xóa
            $('button[data-bs-target="#deleteModal"]').on('click', function () {
                const userId = $(this).data('id');
                $('#deleteModal').data('user-id', userId); // lưu id để xử lý sau
            });

            $('button[data-bs-target="#deleteCardModal"]').on('click', function () {
                const userId = $(this).data('id');
                $('#deleteCardModal').data('user-id', userId); // lưu id để xử lý sau
            });
        }

        // Xử lý xóa sinh viên
        $('#confirmDeleteBtn').on('click', function () {
            const userId = $('#deleteModal').data('user-id');
            if (userId) {
                $.ajax({
                    url: `/api/students/${userId}`,
                    method: 'DELETE',
                    success: function () {
                        $('#deleteModal').modal('hide');
                        showAlert('success', 'Deleted successfully!'); // Hiển thị thông báo thành công
                        loadStudents(currentSearchTerm, currentPage); // Tải lại danh sách sinh viên
                    },
                    error: function () {
                        $('#deleteModal').modal('hide');
                        showAlert('error', 'Delete failed!'); // Hiển thị thông báo lỗi
                    }
                });
            }
        });

        // Xử lý xóa thẻ sinh viên
        $('#confirmDeleteCardBtn').on('click', function () {
            const userId = $('#deleteCardModal').data('user-id');
            if (userId) {
                $.ajax({
                    url: `/api/students/card/${userId}`,
                    method: 'DELETE',
                    success: function () {
                        $('#deleteCardModal').modal('hide');
                        showAlert('success', 'Deleted successfully!'); // Hiển thị thông báo thành công
                        loadStudents(currentSearchTerm, currentPage); // Tải lại danh sách sinh viên
                    },
                    error: function () {
                        $('#deleteCardModal').modal('hide');
                        showAlert('error', 'Delete failed!'); // Hiển thị thông báo lỗi
                    }
                });
            }
        });
    </script>
    <script>
        let currentSortColumn = '';
        let currentSortDirection = 'asc';

        function loadStudents(searchTerm = '', page = 0, sortColumn = currentSortColumn, sortDirection = currentSortDirection) {
            currentSearchTerm = searchTerm;
            currentPage = page;
            currentSortColumn = sortColumn;
            currentSortDirection = sortDirection;

            $.ajax({
                url: `/api/students?page=${page}&size=10&search=${encodeURIComponent(searchTerm)}`
                    + (sortColumn ? `&sort=${sortColumn},${sortDirection}` : ''),
                method: 'GET',
                success: function (data) {
                    renderStudentTable(data.content, data.number, data.size);
                    renderPagination(data);
                    $('#totalRecords').text(data.totalElements);
                    $('#selectedCount').text(0);
                    $('#deleteAllIds').val('');
                    $('input#selectAll').prop('checked', false);
                    $('strong[th\\:text="${students.totalElements}"]').text(data.totalElements);
                },
                error: function (err) {
                    console.error("Error loading students", err);
                }
            });
        }

        $(document).on('click', '.sortable', function () {
            const selectedColumn = $(this).data('sort');

            if (currentSortColumn === selectedColumn) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = selectedColumn;
                currentSortDirection = 'asc';
            }

            $('.sortable .sort-icons i').removeClass('active hidden');

            const sortIcons = $(this).find('.sort-icons');
            const upIcon = sortIcons.find('.bi-caret-up-fill');
            const downIcon = sortIcons.find('.bi-caret-down-fill');

            if (currentSortDirection === 'asc') {
                downIcon.addClass('hidden');
                upIcon.addClass('active');
            } else {
                upIcon.addClass('hidden');
                downIcon.addClass('active');
            }

            loadStudents(currentSearchTerm, currentPage, currentSortColumn, currentSortDirection);
        });
    </script>
    <script>
        let currentSearchTerm = '';
        let currentPage = 0;

        $(document).ready(function () {
            console.log("Document is ready");
            loadStudents();
        });
    </script>
    <script>
        function renderPagination(data) {
            const pagination = $('#pagination');
            pagination.empty();

            const currentPage = data.number;
            const totalPages = data.totalPages;
            const pageSize = data.size;

            const createPageItem = (page, text, isActive, isDisabled, icon = null, ariaLabel = '') => {
                return `
                    <li class="page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${page}" aria-label="${ariaLabel}">
                            ${icon ? `<i class="bi ${icon}"></i>` : text}
                        </a>
                    </li>
                `;
            };

            // First
            pagination.append(createPageItem(0, '', false, data.first, 'bi-chevron-double-left', 'First'));

            // Previous
            pagination.append(createPageItem(currentPage - 1, '', false, data.first, 'bi-chevron-left', 'Previous'));

            // Page 1
            pagination.append(createPageItem(0, '1', currentPage === 0, false));

            // Dấu ...
            if (currentPage > 2) {
                pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }

            // Các trang ở giữa (currentPage -1, currentPage, currentPage +1)
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                if (i > 0 && i < totalPages - 1) {
                    pagination.append(createPageItem(i, `${i + 1}`, i === currentPage, false));
                }
            }

            // Dấu ...
            if (currentPage < totalPages - 3) {
                pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }

            // Last page
            if (totalPages > 1) {
                pagination.append(createPageItem(totalPages - 1, `${totalPages}`, currentPage === totalPages - 1, false));
            }

            // Next
            pagination.append(createPageItem(currentPage + 1, '', false, data.last, 'bi-chevron-right', 'Next'));

            // Last
            pagination.append(createPageItem(totalPages - 1, '', false, data.last, 'bi-chevron-double-right', 'Last'));

            // Gắn sự kiện click
            pagination.find('a.page-link').on('click', function (e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (!isNaN(page)) {
                    loadStudents(currentSearchTerm, page);
                }
            });
        }
    </script>
    <script>
        let debounceTimer;

        $('#searchInput').on('input', function () {
            const searchTerm = $(this).val();

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                loadStudents(searchTerm, 0, currentSortColumn, currentSortDirection);
            }, 300);
        });
    </script>
    <script>
        $('#deleteAllForm').on('submit', function (e) {
            e.preventDefault();
            const userIds = $('.selectItem:checked').map((_, el) => $(el).val()).get();
            if (userIds.length === 0) return;

            $.ajax({
                url: '/api/students/delete-all',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userIds: userIds }),
                success: function () {
                    $('#deleteAllModal').modal('hide');
                    showAlert('success', 'Deleted selected students!');
                    loadStudents();
                },
                error: function () {
                    $('#deleteAllModal').modal('hide');
                    showAlert('error', 'Failed to delete selected students.');
                }
            });
        });
    </script>
    <script>
        $('form').on('submit', function (e) {
            e.preventDefault();
            const searchTerm = $(this).find('input[name="searchTerm"]').val();
            loadStudents(searchTerm);
        });
    </script>
    <script>
        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            $('#alertContainer').html(`
                <div class="alert ${alertClass} alert-dismissible fade show shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} fa-lg me-2"></i>
                        <span>${message}</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

            setTimeout(() => {
                $('.alert').alert('close');
            }, 2000);
        }
    </script>
    <script>
        $(document).ready(function () {
            loadStudents();

            $(document).on('change', '.selectItem, #selectAll', function () {
                const total = $('.selectItem').length;
                const checked = $('.selectItem:checked').length;

                $('#selectedCount').text(checked);
                $('#deleteCount').text(checked);

                $('#selectAll').prop('checked', total > 0 && checked === total);
            });

            $(document).on('change', '#selectAll', function () {
                $('.selectItem').prop('checked', $(this).is(':checked')).trigger('change');
            });
        });
    </script>
    <script>
        document.getElementById("fileInput").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                renderPreviewTable(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhoneNumber(phone) {
            const regex = /^(0|\+84)[0-9]{9,10}$/;
            return regex.test(phone);
        }

        function renderPreviewTable(data) {
            const headerRow = document.getElementById("previewHeaderRow");
            const bodyRows = document.getElementById("previewBodyRows");
            const tableContainer = document.getElementById("previewTableContainer");

            headerRow.innerHTML = "";
            bodyRows.innerHTML = "";

            if (data.length === 0) {
                tableContainer.classList.add("d-none");
                return;
            }

            const headers = data[0];
            window.importHeaders = headers;
            const requiredFields = ["Username", "Password", "First Name", "Last Name", "Email", "2FA Enabled", "Locked"];
            let autoId = 1; // Auto-increment ID nếu ID trống

            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });

            data.slice(1).forEach((row) => {
                if (row.length === 0 || row.every(cell => (cell === undefined || String(cell).trim() === ""))) {
                    return; // Skip dòng trống
                }

                const tr = document.createElement("tr");

                headers.forEach((colName, colIndex) => {
                    const td = document.createElement("td");
                    let cell = row[colIndex];

                    if (colName === "ID" && (cell === undefined || String(cell).trim() === "")) {
                        cell = autoId++;
                    }

                    const value = (cell === undefined || cell === null) ? "" : String(cell).trim();

                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "form-control form-control-sm";
                    input.value = value;

                    let hasError = false;
                    let errorMsg = "";

                    if (requiredFields.includes(colName) && value === "") {
                        hasError = true;
                        errorMsg = `${colName} is required`;
                    }

                    if (colName === "Email" && value && !validateEmail(value)) {
                        hasError = true;
                        errorMsg = "Invalid email format";
                    }

                    if (colName === "Phone Number" && value && !validatePhoneNumber(value)) {
                        hasError = true;
                        errorMsg = "Invalid phone number format";
                    }

                    if (hasError) {
                        input.classList.add("is-invalid");
                        input.setAttribute("title", errorMsg);
                    }

                    input.addEventListener("input", function () {
                        const newValue = input.value.trim();
                        let error = "";

                        input.classList.remove("is-invalid");
                        input.removeAttribute("title");

                        if (requiredFields.includes(colName) && newValue === "") {
                            error = `${colName} is required`;
                        }

                        if (colName === "Email" && newValue && !validateEmail(newValue)) {
                            error = "Invalid email format";
                        }

                        if (colName === "Phone Number" && newValue && !validatePhoneNumber(newValue)) {
                            error = "Invalid phone number format";
                        }

                        if (error) {
                            input.classList.add("is-invalid");
                            input.setAttribute("title", error);
                        }

                        updateDuplicateMarks();
                    });

                    td.appendChild(input);
                    tr.appendChild(td);
                });

                bodyRows.appendChild(tr);
            });

            tableContainer.classList.remove("d-none");

            updateDuplicateMarks(); // Initial duplicate check
        }

        function updateDuplicateMarks() {
            const allRows = document.querySelectorAll("#previewBodyRows tr");
            const idMap = new Map();
            const emailMap = new Map();
            const cardMap = new Map();

            allRows.forEach(row => {
                const cells = row.querySelectorAll("td input");
                const headers = Array.from(document.querySelectorAll("#previewHeaderRow th")).map(th => th.textContent);

                // Clear old duplicate errors
                cells.forEach((input, i) => {
                    const title = input.getAttribute("title");
                    if (title === "Duplicate Student ID" || title === "Duplicate Email" || title === "Duplicate Card Number") {
                        input.classList.remove("is-invalid");
                        input.removeAttribute("title");
                    }
                });

                headers.forEach((colName, index) => {
                    const val = cells[index].value.trim();
                    if (colName === "Student ID") {
                        if (!idMap.has(val)) idMap.set(val, []);
                        idMap.get(val).push(cells[index]);
                    }
                    if (colName === "Email") {
                        if (!emailMap.has(val)) emailMap.set(val, []);
                        emailMap.get(val).push(cells[index]);
                    }
                    if (colName === "Card Number") {
                        if (!cardMap.has(val)) cardMap.set(val, []);
                        cardMap.get(val).push(cells[index]);
                    }
                });
            });

            for (const [val, inputs] of idMap.entries()) {
                if (val && inputs.length > 1) {
                    inputs.forEach(input => {
                        input.classList.add("is-invalid");
                        input.setAttribute("title", "Duplicate Student ID");
                    });
                }
            }

            for (const [val, inputs] of emailMap.entries()) {
                if (val && inputs.length > 1) {
                    inputs.forEach(input => {
                        input.classList.add("is-invalid");
                        input.setAttribute("title", "Duplicate Email");
                    });
                }
            }

            for (const [val, inputs] of cardMap.entries()) {
                if (val && inputs.length > 1) {
                    inputs.forEach(input => {
                        input.classList.add("is-invalid");
                        input.setAttribute("title", "Duplicate Card Number");
                    });
                }
            }
        }
    </script>
    <script>
        function renderDuplicateTable(duplicates, headersInput) {
            const headerRow = document.getElementById("duplicateHeaderRow");
            const bodyRows = document.getElementById("duplicateBodyRows");
            const duplicateCount = document.getElementById("duplicateCount");

            headerRow.innerHTML = "";
            bodyRows.innerHTML = "";
            duplicateCount.textContent = duplicates.length;

            if (duplicates.length === 0) return;

            const headers = [...headersInput, "Duplicate Fields"];

            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });

            duplicates.forEach(item => {
                const student = item.student;
                const tr = document.createElement("tr");

                headers.forEach(key => {
                    const td = document.createElement("td");

                    if (key === "Duplicate Fields") {
                        td.textContent = item.duplicateFields?.join(", ") || "";
                        td.classList.add("fw-bold", "small");
                    } else {
                        const input = document.createElement("input");
                        input.type = "text";
                        input.className = "form-control form-control-sm";

                        const objectKey = key.replace(/\s/g, "").replace(/^./, c => c.toLowerCase());
                        const value = (student[objectKey] !== undefined && student[objectKey] !== null) ? student[objectKey] : "";
                        input.value = value;

                        if (item.duplicateFields?.includes(key)) {
                            td.classList.add('bg-warning');
                        }

                        td.appendChild(input);
                    }

                    tr.appendChild(td);
                });

                bodyRows.appendChild(tr);
            });

            const duplicateModal = new bootstrap.Modal(document.getElementById('duplicateModal'));
            duplicateModal.show();
        }

        function getEditedDuplicateData() {
            const headers = [];
            $('#duplicateHeaderRow th').each(function () {
                headers.push($(this).text());
            });

            const data = [];
            $('#duplicateBodyRows tr').each(function () {
                const row = {};
                $(this).find('td').each(function (i) {
                    const value = $(this).find('input').val();
                    row[headers[i]] = value;
                });
                data.push(row);
            });

            return data;
        }

        $('#reImportBtn').on('click', function () {
            const fixedDuplicates = getEditedDuplicateData();
            $('#loadingOverlay').show();

            $.ajax({
                url: '/api/students/import',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(fixedDuplicates),
                success: function (response) {
                    if (response.duplicates && response.duplicates.length > 0) {
                        renderDuplicateTable(response.duplicates, window.importHeaders);
                    }

                    $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
                    $('#duplicateModal').modal('hide');

                    showAlert('success', response.message || 'Re-import successful!');
                    loadStudents();
                },
                error: function (xhr) {
                    $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
                    showAlert('error', xhr.responseText || 'Re-import failed.');
                }
            });
        });

        function handleImportSuccess(response) {
            $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
            $('#importModal').modal('hide');

            showAlert('success', response.message || 'Imported successfully!');
            loadStudents();
            $('#fileInput').val('');
            $('#previewHeaderRow').empty();
            $('#previewBodyRows').empty();
            $('#previewTableContainer').addClass('d-none');

            if (response.duplicates && response.duplicates.length > 0) {
                renderDuplicateTable(response.duplicates, window.importHeaders);
            }
        }
    </script>
    <script>
        $('#downloadTemplateBtn').on('click', function (e) {
            e.preventDefault();
            window.location.href = '/api/students/download-template';
        });

        function getEditedPreviewData() {
            const rows = document.querySelectorAll("#previewBodyRows tr");
            const headers = Array.from(document.querySelectorAll("#previewHeaderRow th")).map(th => th.textContent.trim());
            const data = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll("td input");
                const rowData = {};
                cells.forEach((cell, index) => {
                    rowData[headers[index]] = cell.value.trim();
                });
                data.push(rowData);
            });

            return data;
        }

        $(document).ready(function () {
            $('#importForm').on('submit', function (e) {
                e.preventDefault();

                const fileInput = $('#fileInput')[0];
                if (!fileInput.files.length) {
                    showAlert('error', 'Please choose a file.');
                    return;
                }

                const editedData = getEditedPreviewData();

                $('#loadingOverlay').show();

                $.ajax({
                    url: '/api/students/import',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(editedData),
                    success: function (response) {
                        $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
                        $('#importModal').modal('hide');
                        if (response.duplicates && response.duplicates.length > 0) {
                            loadStudents();
                            renderDuplicateTable(response.duplicates, window.importHeaders);
                            $('#fileInput').val('');
                            $('#previewHeaderRow').empty();
                            $('#previewBodyRows').empty();
                            $('#previewTableContainer').addClass('d-none');
                        } else {
                            showAlert('success', response.message || 'Imported successfully!');
                            loadStudents();
                            $('#fileInput').val('');
                            $('#previewHeaderRow').empty();
                            $('#previewBodyRows').empty();
                            $('#previewTableContainer').addClass('d-none');
                        }
                    },
                    error: function (xhr) {
                        $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
                        const msg = xhr.responseText || 'Failed to import file';
                        showAlert('error', msg);
                        $('#fileInput').val('');
                        $('#previewHeaderRow').empty();
                        $('#previewBodyRows').empty();
                        $('#previewTableContainer').addClass('d-none');
                    }
                });
            });

            $('#importModal').on('hidden.bs.modal', function () {
                $('#loadingOverlay').get(0).style.setProperty('display', 'none', 'important');
                $('#fileInput').val('');
                $('#previewHeaderRow').empty();
                $('#previewBodyRows').empty();
                $('#previewTableContainer').addClass('d-none');
            });
        });
    </script>
    <script>
        function handleExport() {
            const exportType = document.getElementById('exportType').value;    // student hoặc studentCard
            const exportTarget = document.getElementById('exportTarget').value; // all hoặc selected
            const exportFormat = document.getElementById('exportFormat').value; // excel, csv, pdf

            if (exportTarget === "all") {
                exportAll(exportType, exportFormat);
            } else {
                exportSelected(exportType, exportFormat);
            }
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll(".selectItem:checked")).map(cb => cb.value);
        }

        function updateExportMenuVisibility() {
            const hasSelected = getSelectedIds().length > 0;
            document.querySelectorAll(".export-selected-group").forEach(item => {
                item.style.display = hasSelected ? "block" : "none";
            });
        }

        function exportAll(exportType, exportFormat) {
            showExportSuccessAlert(exportFormat.toUpperCase());
            window.location.href = `/api/students/export?type=${exportType}&format=${exportFormat}`;
        }

        function exportSelected(exportType, exportFormat) {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) {
                alert("Please select at least one student to export.");
                return;
            }

            fetch(`/api/students/export-selected?type=${exportType}&format=${exportFormat}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': getMimeType(exportFormat)
                },
                body: JSON.stringify(selectedIds)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Export lỗi.");
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = 'downloaded_file';
                    if (disposition && disposition.indexOf('filename=') !== -1) {
                        const match = disposition.match(/filename="?([^"]+)"?/);
                        if (match && match[1]) {
                            filename = match[1];
                        }
                    }
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;  // <--- Đặt đúng tên từ backend trả về
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    showExportSuccessAlert(exportFormat.toUpperCase());
                })
                .catch(err => {
                    alert("Failed to export the file.");
                    console.error(err);
                });
        }

        function getMimeType(type) {
            if (type === 'excel') return 'application/vnd.ms-excel';
            if (type === 'csv') return 'text/csv';
            if (type === 'pdf') return 'application/pdf';
            return 'application/octet-stream';
        }

        function showExportSuccessAlert(type) {
            const container = document.getElementById("alertContainer");
            const alertDiv = document.createElement("div");
            alertDiv.className = "alert alert-success alert-dismissible fade show shadow-sm";
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-lg me-2"></i>
                    <span>${type} file exported successfully! Download in progress...</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.prepend(alertDiv);
            setTimeout(() => new bootstrap.Alert(alertDiv).close(), 2000);
        }
    </script>
    <script>
        document.getElementById("cardFileInput").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                renderPreviewTable(json);
            };
            reader.readAsArrayBuffer(file);
        });

        let currentUserId = null;

        // Hàm mở modal và gán studentId
        window.openImportCardModal = function (userId) {
            currentUserId = userId;
            $('#studentIdInput').val(userId); // Gán vào input hidden
            $('#importCardModal').modal('show');
        };

        $(document).ready(function () {
            // Download Template
            $('#downloadCardTemplateBtn').on('click', function (e) {
                e.preventDefault();
                window.location.href = '/api/students/card-template';
            });

            // Submit Form Import Card
            $('#importCardForm').on('submit', function (e) {
                e.preventDefault();

                const fileInput = $('#cardFileInput')[0];
                if (!fileInput.files.length) {
                    showAlert('error', 'Please choose a card file.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet); // <<< Chuyển thành object JSON

                    $.ajax({
                        url: '/api/students/import-card',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(json),
                        success: function (response) {
                            $('#importCardModal').modal('hide');
                            showAlert('success', response.message || 'Card imported successfully!');
                            loadStudents();
                            $('#cardFileInput').val('');
                        },
                        error: function (xhr) {
                            $('#importCardModal').modal('hide');
                            const msg = xhr.responseText || 'Failed to import card file.';
                            showAlert('error', msg);
                            $('#cardFileInput').val('');
                        }
                    });
                };
                reader.readAsArrayBuffer(fileInput.files[0]);
            });

            // Reset khi modal đóng
            $('#importCardModal').on('hidden.bs.modal', function () {
                $('#cardFileInput').val('');
                currentUserId = null;
            });
        });
    </script>
</div>